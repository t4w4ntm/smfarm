<!doctype html>
<html lang="th" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coffee Smart Farm</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="icon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png">

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏µ‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô localStorage -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('smfarm-theme') || 'light';
        document.documentElement.setAttribute('data-theme', saved);
      } catch {}
    })();
  </script>

  <!-- Chart.js + dayjs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <strong style="font-size:18px;">üå± Coffee Smart Farm</strong>
        <span class="badge" id="updated">‚Äì</span>
      </div>
      <div class="tools" style="gap:8px; flex-wrap:wrap;">
        <div class="quick" role="group" aria-label="‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡∏î‡πà‡∏ß‡∏ô" style="display:flex; gap:4px;">
          <button class="chip" id="rangeToday" aria-pressed="false" type="button">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button class="chip" id="range7" aria-pressed="false" type="button">7 ‡∏ß‡∏±‡∏ô</button>
          <button class="chip" id="range30" aria-pressed="false" type="button">30 ‡∏ß‡∏±‡∏ô</button>
          <button class="chip export" id="exportCsvBtn" type="button" title="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV">Export</button>
        </div>
      </div>
    </div>

    <!-- Filters (‡πÑ‡∏°‡πà sticky ‡πÅ‡∏•‡πâ‡∏ß) -->
    <div class="filters" role="region" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
      <div class="grid cols-4">
        <div class="field" data-click-focus>
          <span class="label">Device</span>
          <select id="deviceFilter" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"></select>
        </div>
        <div class="field" data-click-focus>
          <span class="label">Points (‡∏ï‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü)</span>
          <select id="pointFilter">
            <option value="50">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏à‡∏∏‡∏î</option>
            <option value="100" selected>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 100 ‡∏à‡∏∏‡∏î</option>
            <option value="200">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 200 ‡∏à‡∏∏‡∏î</option>
          </select>
        </div>
        <div class="field" data-click-focus>
          <span class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
          <input type="date" id="startDateFilter">
        </div>
        <div class="field" data-click-focus>
          <span class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</span>
          <input type="date" id="endDateFilter">
        </div>
      </div>

      <!-- ‡πÅ‡∏ñ‡∏ß‡∏ä‡πà‡∏ß‡∏á‡∏î‡πà‡∏ß‡∏ô + ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà header -->
    </div>

    <!-- KPIs -->
    <div class="section"><h2>KPIs</h2><div class="rule"></div></div>
    <div class="kpis">
      <div class="card kpi"><div class="name">EC (¬µS/cm)</div><div class="val" id="ec">‚Äì</div></div>
      <div class="card kpi"><div class="name">pH</div><div class="val" id="ph">‚Äì</div></div>
      <div class="card kpi"><div class="name">N (ppm)</div><div class="val" id="n">‚Äì</div></div>
      <div class="card kpi"><div class="name">P (ppm)</div><div class="val" id="p">‚Äì</div></div>
      <div class="card kpi"><div class="name">K (ppm)</div><div class="val" id="k">‚Äì</div></div>
      <div class="card kpi"><div class="name">MOI (%)</div><div class="val" id="moi">‚Äì</div></div>
      <div class="card kpi"><div class="name">Battery (%)</div><div class="val" id="bat">‚Äì</div></div>
      <div class="card kpi">
        <div class="name">Signal</div>
        <div class="val" style="font-size:18px;"><span id="rssi">‚Äì</span> / <span id="snr">‚Äì</span></div>
        <div class="name" id="dev">‚Äì</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="section" style="margin-top:18px;"><h2>Live Chart</h2><div class="rule"></div></div>
    <div class="panel"><canvas id="chart"></canvas></div>

    <!-- Summary -->
    <div class="section"><h2>Summary (Avg / Min / Max)</h2><div class="rule"></div></div>
    <div class="summary" id="summaryGrid"></div>

    <!-- Table -->
    <div class="section"><h2>Recent Uplinks</h2><div class="rule"></div></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="min-width:150px;">Time</th>
            <th>Device</th>
            <th>EC</th><th>pH</th><th>N</th><th>P</th><th>K</th><th>MOI</th><th>BAT</th>
            <th>RSSI</th><th>SNR</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Toast stack + live region for filter feedback -->
  <div id="toastStack" aria-live="polite" aria-atomic="true"></div>
  <div id="filterAnnouncer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <!-- Export Modal -->
  <div id="exportModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.4);">
    <div class="card" role="dialog" aria-modal="true" aria-labelledby="exportTitle" style="width:min(520px,92vw);">
      <h3 id="exportTitle" style="margin:6px 0 10px;">Export CSV</h3>
      <div class="grid cols-3">
        <div class="field">
          <span class="label">‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏£‡∏ß‡∏°)</span>
          <input type="datetime-local" id="exportStart">
        </div>
        <div class="field">
          <span class="label">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏£‡∏ß‡∏°)</span>
          <input type="datetime-local" id="exportEnd">
        </div>
        <div class="field">
          <span class="label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå</span>
          <select id="exportFormat">
            <option value="csv" selected>CSV (.csv)</option>
          </select>
        </div>
      </div>
      <div class="tools" style="justify-content:flex-end; margin-top:10px;">
        <button class="btn secondary" id="exportCancel" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn" id="exportConfirm" type="button">Export</button>
      </div>
    </div>
  </div>

  <!-- Floating Theme Toggle -->
  <button class="floating-toggle" id="themeToggle" type="button" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡∏≤‡∏ß/‡∏î‡∏≥">‚òÄ</button>

  <script src="app.js"></script>
</body>
</html>
