<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Farm ‚Äì Live (Google Sheet)</title>

  <!-- Chart.js + dayjs (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <style>
    /* ====== Liquid Glass (iOS-style) ====== */
    :root{
      --bg1:#0b1220;
      --bg2:#13233f;
      --glass:#ffffff10;
      --glass-2:#ffffff08;
      --border:#ffffff33;
      --txt:#e9f0ff;
      --muted:#a9b7d6;
      --accent:#77bfff;
      --ok:#22d3ee;
      --warn:#f59e0b;
      --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt); font:15px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      min-height:100vh;
      background: radial-gradient(1200px 900px at 15% -10%, #1e2d54 0%, #0b1220 55%, #080d18 100%),
                  radial-gradient(800px 700px at 85% 120%, #193b77 0%, transparent 60%);
    }
    .wrap{
      max-width:1200px; margin:32px auto; padding:0 16px;
    }
    .header{
      display:flex; align-items:center; gap:16px; justify-content:space-between; margin-bottom:18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:16px; backdrop-filter: blur(10px);
      background:linear-gradient(180deg, #ffffff12, #ffffff05); border:1px solid var(--border);
      box-shadow: 0 10px 30px #00000055 inset, 0 30px 60px #00000040;
    }
    .brand .logo{
      width:28px; height:28px; display:grid; place-items:center;
      background: radial-gradient(65% 65% at 30% 30%, #86efac, #22d3ee);
      border-radius:9px; box-shadow:0 6px 18px #22d3ee55 inset, 0 -6px 18px #86efac44 inset;
    }
    .brand h1{ margin:0; font-size:18px; letter-spacing:.3px; }
    .status{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--border); color:#cfe9ff;
      background:linear-gradient(180deg,#ffffff1a,#ffffff08); backdrop-filter:blur(8px);
    }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:12px; margin:6px 0 18px;
    }
    .select{
      position:relative; min-width:220px;
      background:var(--glass); border:1px solid var(--border); border-radius:14px;
      padding:10px 12px; backdrop-filter:blur(8px);
    }
    select{
      width:100%; background:transparent; border:none; outline:none; color:var(--txt);
      font-size:15px;
    }
    /* Make dropdown list clearly visible on dark bg */
    .select select option, .select select optgroup{
      background:#0f1730; /* solid dark list */
      color:var(--txt);
    }
    .select select option:checked,
    .select select option:hover{
      background:#1c2c52; /* highlight */
      color:#fff;
    }
    /* small polish for old IE/Edge arrows */
    select::-ms-expand{ display:none; }

    .grid{
      display:grid; grid-template-columns:repeat(6,1fr); gap:14px; margin-bottom:14px;
    }
    .card{
      background: linear-gradient(180deg,var(--glass),var(--glass-2));
      border:1px solid var(--border); border-radius:18px; padding:16px 16px 14px; backdrop-filter: blur(10px);
      box-shadow: 0 6px 25px #00000045 inset, 0 12px 40px #00000035;
    }
    .metric .label{ color:var(--muted); font-size:13px; letter-spacing:.3px; }
    .metric .value{ font-size:28px; font-weight:700; margin-top:2px; }
    .metric small{ color:var(--muted); }

    .panel{
      background: linear-gradient(180deg,var(--glass),var(--glass-2));
      border:1px solid var(--border); border-radius:18px; padding:14px; backdrop-filter: blur(12px);
      margin-top:14px; box-shadow: 0 6px 25px #00000045 inset, 0 12px 40px #00000035;
    }
    .panel h3{ margin:2px 4px 12px; font-size:16px; color:#d7e8ff; }
    canvas{ width:100% !important; height:360px !important; }

    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left; color:#cfe2ff; font-weight:600; padding:10px 8px; border-bottom:1px solid var(--border);
      position:sticky; top:0; background:#0f1730cc; backdrop-filter: blur(4px);
    }
    tbody td{ padding:10px 8px; border-bottom:1px dashed #ffffff1f; color:#eaf3ff; }
    tbody tr:hover{ background:#ffffff08; }

    .muted{ color:var(--muted); }
    .signal{ display:flex; gap:8px; align-items:baseline; }
    @media (max-width:980px){ .grid{ grid-template-columns:repeat(2,1fr); } canvas{ height:280px !important; } }
    @media (max-width:640px){
      .grid{ grid-template-columns:1fr; }
      .brand h1{ font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo">üå±</div>
        <h1>Smart Farm ‚Äì Live</h1>
      </div>
      <div class="status">
        <div class="pill" id="connected">connected</div>
        <div class="pill muted" id="updated">‚Äì</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="toolbar">
      <div class="select">
        <div class="muted" style="font-size:12px;margin-bottom:2px;">Device</div>
        <select id="deviceFilter"></select>
      </div>
      <div class="select">
        <div class="muted" style="font-size:12px;margin-bottom:2px;">Points</div>
        <select id="pointFilter">
          <option value="50">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏à‡∏∏‡∏î</option>
          <option value="100" selected>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 100 ‡∏à‡∏∏‡∏î</option>
          <option value="200">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 200 ‡∏à‡∏∏‡∏î</option>
        </select>
      </div>
      <div class="select">
        <div class="muted" style="font-size:12px;margin-bottom:2px;">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</div>
        <select id="refreshFilter">
          <option value="15">15</option>
          <option value="30" selected>30</option>
          <option value="60">60</option>
        </select>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid" id="kpiGrid">
      <div class="card metric"><div class="label">EC (¬µS/cm)</div><div class="value" id="ec">‚Äì</div></div>
      <div class="card metric"><div class="label">pH</div><div class="value" id="ph">‚Äì</div></div>
      <div class="card metric"><div class="label">N (ppm)</div><div class="value" id="n">‚Äì</div></div>
      <div class="card metric"><div class="label">P (ppm)</div><div class="value" id="p">‚Äì</div></div>
      <div class="card metric"><div class="label">K (ppm)</div><div class="value" id="k">‚Äì</div></div>
      <div class="card metric">
        <div class="label">Signal</div>
        <div class="value signal"><span id="rssi">‚Äì</span><small class="muted">/</small><span id="snr">‚Äì</span></div>
        <small class="muted" id="dev">‚Äì</small>
      </div>
    </div>

    <!-- Chart -->
    <div class="panel">
      <h3>Live Chart</h3>
      <canvas id="chart"></canvas>
    </div>

    <!-- Table -->
    <div class="panel">
      <h3>Recent uplinks</h3>
      <div style="overflow:auto; max-height:380px;">
        <table>
          <thead>
            <tr>
              <th style="min-width:150px;">Time</th>
              <th>Device</th>
              <th>EC</th><th>pH</th><th>N</th><th>P</th><th>K</th>
              <th>RSSI</th><th>SNR</th><th>MOI</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:10px;">Liquid Glass UI ‚Ä¢ Data from Google Sheet (gviz) ‚Ä¢ open-source</div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
/** 1) ‡∏ß‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ SHEET_ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏î‡∏π‡∏à‡∏≤‡∏Å URL ‡∏Ç‡∏≠‡∏á Google Sheet) */
const SHEET_ID   = '1iSRn3PrGgr0F7T-c-mKnEa-nmRU0PH626D3hLe7V7Jw';
/** 2) ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó/‡πÅ‡∏ó‡πá‡∏ö (‡πÄ‡∏ä‡πà‡∏ô 'data') */
const SHEET_NAME = 'data';
/** mapping ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: A..K
 *  A=ts  B=deviceId  C=devEui  D=EC  E=pH  F=N  G=P  H=K  I=rssi  J=snr  K=MOI
 */
const COLS = { ts:0, device:1, devEui:2, ec:3, ph:4, n:5, p:6, k:7, rssi:8, snr:9, moi:10 };

/* ============ helpers ============ */
function gvizURL(limit=100){
  // query: select all columns, order by time desc, limit N
  const query = `select A,B,C,D,E,F,G,H,I,J,K order by A desc limit ${limit}`;
  const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq` +
               `?sheet=${encodeURIComponent(SHEET_NAME)}` +
               `&tqx=out:json` +
               `&tq=${encodeURIComponent(query)}`;
  return base;
}

// gviz JSON ‚Üí object
function parseGviz(text){
  const start = text.indexOf('(')+1;
  const end   = text.lastIndexOf(')');
  const json  = JSON.parse(text.slice(start, end));
  const cols  = json.table.cols.map(c => c.label || c.id || '');
  const rows  = (json.table.rows || []).map(r => {
    const row = r.c.map(cell => cell ? cell.v : null);
    return row;
  });
  return { cols, rows };
}

// Date(2025,8,9,18,34,12) ‚Üí Date
function parseDateToken(v){
  if (typeof v === 'string' && v.startsWith('Date(')){
    const m = /Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/.exec(v);
    if (m){
      const [_,y,mo,d,h,mi,s] = m.map(Number);
      return new Date(y, mo, d, h, mi, s);
    }
  }
  if (v instanceof Date) return v;
  return v ? new Date(v) : null;
}

function fmtTime(d){ return d ? dayjs(d).format('YYYY-MM-DD HH:mm:ss') : '‚Äì'; }
function toNum(v){ const n=Number(v); return Number.isFinite(n) ? n : null; }
function uniq(arr){ return [...new Set(arr)]; }

/* ============ state ============ */
let CHART;
let cache = [];        // ‡πÄ‡∏Å‡πá‡∏ö rows ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
let timer;

/* ============ DOM refs ============ */
const ddDevice   = document.getElementById('deviceFilter');
const ddPoints   = document.getElementById('pointFilter');
const ddRefresh  = document.getElementById('refreshFilter');
const elUpdated  = document.getElementById('updated');
const elEC = document.getElementById('ec');
const elPH = document.getElementById('ph');
const elN  = document.getElementById('n');
const elP  = document.getElementById('p');
const elK  = document.getElementById('k');
const elRSSI = document.getElementById('rssi');
const elSNR  = document.getElementById('snr');
const elDev  = document.getElementById('dev');
const tbody  = document.getElementById('tableBody');

/* ============ main fetch ============ */
async function fetchSheet(limit){
  const res  = await fetch(gvizURL(limit), {cache:'no-store'});
  const text = await res.text();
  const { rows } = parseGviz(text);

  // ‡πÅ‡∏õ‡∏•‡∏á rows ‡πÄ‡∏õ‡πá‡∏ô object ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
  const data = rows.map(r => {
    const d = {
      ts:  parseDateToken(r[COLS.ts]),
      device: r[COLS.device] ?? '',
      devEui: r[COLS.devEui] ?? '',
      ec:  toNum(r[COLS.ec]),
      ph:  toNum(r[COLS.ph]),
      n:   toNum(r[COLS.n]),
      p:   toNum(r[COLS.p]),
      k:   toNum(r[COLS.k]),
      rssi:toNum(r[COLS.rssi]),
      snr: toNum(r[COLS.snr]),
      moi: toNum(r[COLS.moi]),
    };
    return d;
  });

  // rows ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠ order by A desc (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô)
  cache = data;
  elUpdated.textContent = 'updated: ' + (data[0] ? fmtTime(data[0].ts) : '-');

  // build device filter
  const devices = uniq(data.map(d => d.device).filter(Boolean));
  const cur = ddDevice.value;
  ddDevice.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${devices.length})</option>` +
    devices.map(x => `<option ${x===cur?'selected':''} value="${x}">${x}</option>`).join('');
}

function filterRows(){
  const device = ddDevice.value;
  return device ? cache.filter(r => r.device === device) : cache.slice();
}

function updateKPIs(latest){
  if (!latest){ elEC.textContent = elPH.textContent = elN.textContent = elP.textContent = elK.textContent = '‚Äì'; return; }
  elEC.textContent = latest.ec ?? '‚Äì';
  elPH.textContent = latest.ph ?? '‚Äì';
  elN.textContent  = latest.n  ?? '‚Äì';
  elP.textContent  = latest.p  ?? '‚Äì';
  elK.textContent  = latest.k  ?? '‚Äì';
  elRSSI.textContent = (latest.rssi ?? '‚Äì');
  elSNR.textContent  = (latest.snr  ?? '‚Äì');
  elDev.textContent  = latest.device && latest.devEui ? `${latest.device} ¬∑ ${latest.devEui}` : (latest.device || latest.devEui || '‚Äì');
}

function updateTable(rows){
  tbody.innerHTML = rows.slice(0, 50).map(r => `
    <tr>
      <td>${fmtTime(r.ts)}</td>
      <td>${r.device || ''}</td>
      <td>${r.ec ?? ''}</td>
      <td>${r.ph ?? ''}</td>
      <td>${r.n ?? ''}</td>
      <td>${r.p ?? ''}</td>
      <td>${r.k ?? ''}</td>
      <td>${r.rssi ?? ''}</td>
      <td>${r.snr ?? ''}</td>
      <td>${r.moi ?? ''}</td>
    </tr>`).join('');
}

function makeChart(ctx){
  return new Chart(ctx, {
    type:'line',
    data:{
      labels: [],
      datasets:[
        {label:'EC', borderColor:'#60a5fa', backgroundColor:'transparent', data: [], tension:.25},
        {label:'pH', borderColor:'#f472b6', backgroundColor:'transparent', data: [], tension:.25},
        {label:'N',  borderColor:'#f59e0b', backgroundColor:'transparent', data: [], tension:.25},
        {label:'P',  borderColor:'#fde047', backgroundColor:'transparent', data: [], tension:.25},
        {label:'K',  borderColor:'#34d399', backgroundColor:'transparent', data: [], tension:.25},
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'nearest', intersect:false },
      plugins:{ legend:{ labels:{ color:'#dfeaff' } } },
      scales:{
        x:{ ticks:{ color:'#bcd1ff' }, grid:{ color:'#ffffff14' } },
        y:{ ticks:{ color:'#bcd1ff' }, grid:{ color:'#ffffff14' } }
      }
    }
  });
}

function updateChart(rows){
  const labels = rows.map(r => dayjs(r.ts).format('HH:mm:ss')).reverse();
  const ec = rows.map(r => r.ec).reverse();
  const ph = rows.map(r => r.ph).reverse();
  const n  = rows.map(r => r.n).reverse();
  const p  = rows.map(r => r.p).reverse();
  const k  = rows.map(r => r.k).reverse();

  CHART.data.labels = labels;
  CHART.data.datasets[0].data = ec;
  CHART.data.datasets[1].data = ph;
  CHART.data.datasets[2].data = n;
  CHART.data.datasets[3].data = p;
  CHART.data.datasets[4].data = k;
  CHART.update('none');
}

async function refresh(){
  const limit = Number(ddPoints.value || 100);
  await fetchSheet(limit);
  const rows = filterRows();
  const latest = rows[0];

  updateKPIs(latest);
  updateChart(rows);
  updateTable(rows);
}

function startAuto(){
  if (timer) clearInterval(timer);
  const sec = Number(ddRefresh.value || 30);
  timer = setInterval(refresh, sec*1000);
}

/* ========= boot ========= */
window.addEventListener('DOMContentLoaded', async () => {
  CHART = makeChart(document.getElementById('chart').getContext('2d'));

  // listeners
  ddDevice.addEventListener('change', () => { const rows=filterRows(); updateKPIs(rows[0]); updateChart(rows); updateTable(rows); });
  ddPoints.addEventListener('change', refresh);
  ddRefresh.addEventListener('change', startAuto);

  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SHEET_ID
  if (SHEET_ID === 'YOUR_SHEET_ID_HERE'){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà SHEET_ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
  }

  await refresh();
  startAuto();
});
</script>
</body>
</html>
