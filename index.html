<!doctype html>
<html lang="th" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Farm – Live (Google Sheet)</title>

  <!-- ===== Preload theme (avoid FOUC) ===== -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('smfarm-theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      } catch (e) {}
    })();
  </script>

  <!-- Chart.js + dayjs (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <style>
    /* ====== Design tokens (Dark/Light) ====== */
    :root{
      /* dark by default */
      --bg1:#0b1220;
      --bg2:#13233f;
      --glass:#ffffff10;
      --glass-2:#ffffff08;
      --border:#ffffff33;
      --txt:#e9f0ff;
      --muted:#a9b7d6;
      --accent:#77bfff;
      --ok:#22d3ee; --warn:#f59e0b; --err:#ef4444;

      /* bg gradients (dark) */
      --bg1-grad1:#1e2d54; --bg1-grad2:#0b1220; --bg1-grad3:#080d18;
      --bg2-grad1:#193b77;

      /* table header bg */
      --thead-bg:#0f1730cc;
    }
    html[data-theme="light"]{
      --bg1:#ecf3ff;
      --bg2:#dfe8fb;
      --glass:#0000000f;
      --glass-2:#00000007;
      --border:#00000024;
      --txt:#0f172a;
      --muted:#5b6b85;
      --accent:#2563eb;
      --ok:#06b6d4; --warn:#b45309; --err:#dc2626;

      --bg1-grad1:#ffffff;
      --bg1-grad2:#f1f6ff;
      --bg1-grad3:#e8f0ff;
      --bg2-grad1:#d9e6ff;

      --thead-bg:#ffffffcc;
    }

    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt);
      font:15px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      min-height:100vh;
      background:
        radial-gradient(1200px 900px at 15% -10%, var(--bg1-grad1) 0%, var(--bg1-grad2) 55%, var(--bg1-grad3) 100%),
        radial-gradient(800px 700px at 85% 120%, var(--bg2-grad1) 0%, transparent 60%);
      transition: background 280ms ease, color 180ms ease;
    }
    .wrap{ max-width:1200px; margin:32px auto; padding:0 16px; }

    /* ===== Header ===== */
    .header{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:16px; justify-content:space-between; margin-bottom:18px;
      padding-top:4px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:16px; backdrop-filter: blur(10px);
      background:linear-gradient(180deg, var(--glass), var(--glass-2)); border:1px solid var(--border);
      box-shadow: 0 10px 30px #00000040;
    }
    .brand .logo{
      width:28px; height:28px; display:grid; place-items:center;
      background: radial-gradient(65% 65% at 30% 30%, #86efac, #22d3ee);
      border-radius:9px; box-shadow:0 6px 18px #22d3ee55 inset, 0 -6px 18px #86efac44 inset;
      font-size:18px;
    }
    .brand h1{ margin:0; font-size:18px; letter-spacing:.3px; }
    .status{ display:flex; align-items:center; gap:10px; }

    /* ===== Pills / Buttons ===== */
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--border); color:inherit;
      background:linear-gradient(180deg,var(--glass),var(--glass-2)); backdrop-filter:blur(8px);
    }
    .pill.clickable{ cursor:pointer; transition: transform .08s ease, box-shadow .2s ease, background .2s ease; user-select:none; }
    .pill.clickable:hover{ box-shadow: 0 0 0 2px #ffffff22 inset; background:linear-gradient(180deg,#ffffff2a,#ffffff10); }
    html[data-theme="light"] .pill.clickable:hover{ box-shadow: 0 0 0 2px #00000014 inset; background:linear-gradient(180deg,#00000010,#00000005); }
    .pill.clickable:active{ transform: translateY(1px) scale(.98); }
    .pill.clickable:focus-visible{ outline:2px solid #7dd3fc; outline-offset:2px; }
    .pill.active{ box-shadow: 0 0 0 2px var(--ok) inset; background:linear-gradient(180deg, #22d3ee33, #22d3ee14); }

    .btn{ border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease; }
    .btn:hover{ filter: brightness(1.05); box-shadow: 0 6px 20px #0006; }
    .btn:active{ transform: translateY(1px) scale(.98); }
    .btn:focus-visible{ outline:2px solid #7dd3fc; outline-offset:2px; }
    .btn.primary{ background: linear-gradient(135deg,#22d3ee,#2563eb); color: #fff; border: none; }
    .btn.ghost{ background: transparent; color: inherit; }

    /* Export button hover animation */
    #exportCsvBtn{ transition: all .15s ease; box-shadow: 0 4px 12px #22d3ee40; }
    #exportCsvBtn:hover{ transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 25px #22d3ee60, 0 0 0 3px #ffffff25 inset; filter: brightness(1.1); }
    #exportCsvBtn:active{ transform: translateY(0) scale(.98); box-shadow: 0 2px 8px #22d3ee50; }

    /* Ripple effect */
    .ripple-surface{ position: relative; overflow: hidden; }
    .ripple{ position:absolute; border-radius:50%; pointer-events:none; transform: scale(0); opacity: .35; background: #fff; animation: ripple 600ms ease-out forwards; mix-blend-mode: screen; }
    @keyframes ripple{ to{ transform: scale(4); opacity: 0; } }

    /* ===== Toolbar / Filters ===== */
    .toolbar{ display:flex; flex-wrap:wrap; gap:12px; margin:6px 0 18px; }
    .select{
      position:relative; min-width:220px;
      background:var(--glass); border:1px solid var(--border); border-radius:14px;
      padding:10px 12px; backdrop-filter:blur(8px);
    }
    select, input[type="date"], input[type="datetime-local"]{
      width:100%; background:transparent; border:none; outline:none; color:var(--txt);
      font-size:15px;
    }
    .select .muted{ font-size:12px; margin-bottom:2px; color:var(--muted); }

    /* dropdown list palettes */
    .select select option, .select select optgroup{ background:#0f1730; color:var(--txt); }
    .select select option:checked, .select select option:hover{ background:#1c2c52; color:#fff; }
    html[data-theme="light"] .select select option, html[data-theme="light"] .select select optgroup{ background:#ffffff; color:#0f172a; }
    html[data-theme="light"] .select select option:checked, html[data-theme="light"] .select select option:hover{ background:#e6eefc; color:#0f172a; }
    select::-ms-expand{ display:none; }

    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="datetime-local"]::-webkit-calendar-picker-indicator{ filter: invert(1); cursor: pointer; }
    html[data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator,
    html[data-theme="light"] input[type="datetime-local"]::-webkit-calendar-picker-indicator{ filter: none; }

    /* ===== Cards / Panels ===== */
    .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:14px; }
    .card{
      background: linear-gradient(180deg,var(--glass),var(--glass-2));
      border:1px solid var(--border); border-radius:18px; padding:16px 16px 14px; backdrop-filter: blur(10px);
      box-shadow: 0 6px 25px #00000025 inset, 0 12px 40px #00000020;
      transition: transform .08s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-1px); box-shadow: 0 10px 30px #00000030; }
    .metric .label{ color:var(--muted); font-size:13px; letter-spacing:.3px; }
    .metric .value{ font-size:28px; font-weight:700; margin-top:2px; }
    .metric small{ color:var(--muted); }

    .panel{
      background: linear-gradient(180deg,var(--glass),var(--glass-2));
      border:1px solid var(--border); border-radius:18px; padding:14px; backdrop-filter: blur(12px);
      margin-top:14px; box-shadow: 0 6px 25px #00000025 inset, 0 12px 40px #00000020;
    }
    .panel h3{ margin:2px 4px 12px; font-size:16px; color:var(--txt); }

  /* Light theme: remove edge shadows on all cards/panels */
  html[data-theme="light"] .card{ box-shadow: none; }
  html[data-theme="light"] .card:hover{ box-shadow: none; }
  html[data-theme="light"] .panel{ box-shadow: none; }

    canvas{ width:100% !important; height:360px !important; }

    /* ===== Table ===== */
    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left; color:inherit; font-weight:600; padding:10px 8px; border-bottom:1px solid var(--border);
      position:sticky; top:0; background:var(--thead-bg); backdrop-filter: blur(4px);
    }
    tbody td{ padding:10px 8px; border-bottom:1px dashed #ffffff1f; color:inherit; }
    html[data-theme="light"] tbody td{ border-bottom:1px dashed #00000015; }
    tbody tr:hover{ background:#ffffff08; }
    html[data-theme="light"] tbody tr:hover{ background:#00000008; }

    .muted{ color:var(--muted); }
    .signal{ display:flex; gap:8px; align-items:baseline; }

    /* ===== Modal ===== */
    .modal-backdrop{
      position: fixed; inset: 0; background: #0009; display:none; align-items:center; justify-content:center; z-index: 50;
    }
    .modal{
      width: min(520px, 92vw);
      background: linear-gradient(180deg,var(--glass),var(--glass-2)); border:1px solid var(--border);
      border-radius: 16px; padding: 16px; box-shadow: 0 10px 40px #0008; backdrop-filter: blur(10px);
    }
    .modal h4{ margin: 4px 0 12px; color: var(--txt); font-size: 16px; }
    .modal .row{ display:flex; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
    .modal .field{ flex:1; min-width: 200px; }
    .modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top: 8px; }

    /* Light theme: make export modal brighter and crisper */
    html[data-theme="light"] .modal{
      background: #ffffff;            /* solid bright card */
      border-color: #0000001f;        /* subtle border */
      box-shadow: none;               /* keep light mode shadowless */
      backdrop-filter: none;          /* remove glass blur to avoid blending */
    }
    html[data-theme="light"] .modal .select{
      background: #ffffff;            /* inputs look solid inside modal */
      border-color: #00000022;
      backdrop-filter: none;
    }

    /* ===== Floating Theme Toggle ===== */
    .theme-fab{
      position: fixed; right:18px; bottom:18px; z-index:60;
      display:flex; align-items:center; gap:10px;
    }
    .theme-fab .fab-btn{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--border);
      background: linear-gradient(180deg,var(--glass),var(--glass-2));
      backdrop-filter: blur(12px);
      padding:10px 12px; border-radius:999px; cursor:pointer;
      box-shadow: 0 10px 30px #00000035;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
      color:inherit;
    }
    .theme-fab .fab-btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 38px #00000044; }
    .theme-fab .icon{
      width:22px; height:22px; display:inline-block;
    }
    .theme-fab .label{ font-weight:600; letter-spacing:.2px; }

    /* compact on very small screens */
    @media (max-width:420px){
      .theme-fab .label{ display:none; }
    }

    /* ===== Responsive ===== */
    @media (max-width:980px){ .grid{ grid-template-columns:repeat(2,1fr); } canvas{ height:280px !important; } }
    @media (max-width:640px){
      .grid{ grid-template-columns:1fr; }
      .brand h1{ font-size:16px; }
      .toolbar .select{ min-width:160px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand" aria-label="Smart Farm header">
        <div class="logo" aria-hidden="true">🌱</div>
        <h1>Smart Farm – Live</h1>
      </div>
      <div class="status">
        <div class="pill" id="connected" aria-live="polite">connected</div>
        <div class="pill muted" id="updated">–</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="toolbar">
      <div class="select">
        <div class="muted">Device</div>
        <select id="deviceFilter" aria-label="เลือกอุปกรณ์"></select>
      </div>
      <div class="select">
        <div class="muted">Points</div>
        <select id="pointFilter" aria-label="จำนวนจุดข้อมูลล่าสุด">
          <option value="50">ล่าสุด 50 จุด</option>
          <option value="100" selected>ล่าสุด 100 จุด</option>
          <option value="200">ล่าสุด 200 จุด</option>
        </select>
      </div>
      <div class="select">
        <div class="muted">วันที่เริ่มต้น</div>
        <input type="date" id="startDateFilter" aria-label="วันที่เริ่มต้น">
      </div>
      <div class="select">
        <div class="muted">วันที่สิ้นสุด</div>
        <input type="date" id="endDateFilter" aria-label="วันที่สิ้นสุด">
      </div>
      <div class="select">
        <div class="muted">รีเฟรช (วินาที)</div>
        <select id="refreshFilter" aria-label="ช่วงเวลารีเฟรช">
          <option value="15">15</option>
          <option value="30" selected>30</option>
          <option value="60">60</option>
        </select>
      </div>

      <button class="pill ripple-surface" id="exportCsvBtn" style="cursor:pointer; background: linear-gradient(135deg,#22d3ee,#2563eb); color:white; border:none; display:flex; align-items:center; gap:8px;"
        aria-haspopup="dialog" aria-controls="exportModal">
        <span>Export</span>
      </button>

      <div style="margin-left: auto; display: flex; gap: 12px;">
        <div class="pill clickable ripple-surface" id="rangeToday" role="button" tabindex="0" aria-pressed="false">Today</div>
        <div class="pill clickable ripple-surface" id="range7" role="button" tabindex="0" aria-pressed="false">7 Days</div>
        <div class="pill clickable ripple-surface" id="range30" role="button" tabindex="0" aria-pressed="false">30 Days</div>
      </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="exportTitle">
        <h4 id="exportTitle">Export CSV</h4>
        <div class="row">
          <div class="field select">
            <div class="muted">วันที่เริ่มต้น (รวม)</div>
            <input type="datetime-local" id="exportStart">
          </div>
          <div class="field select">
            <div class="muted">วันที่สิ้นสุด (รวม)</div>
            <input type="datetime-local" id="exportEnd">
          </div>
        </div>
        <div class="row">
          <div class="field select">
            <div class="muted">รูปแบบไฟล์</div>
            <select id="exportFormat">
              <option value="csv" selected>CSV (.csv)</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost ripple-surface" id="exportCancel">Cancel</button>
          <button class="btn primary ripple-surface" id="exportConfirm" style="transition: all .15s ease;">Export</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid" id="kpiGrid">
      <div class="card metric"><div class="label">EC (µS/cm)</div><div class="value" id="ec">–</div></div>
      <div class="card metric"><div class="label">pH</div><div class="value" id="ph">–</div></div>
      <div class="card metric"><div class="label">N (ppm)</div><div class="value" id="n">–</div></div>
      <div class="card metric"><div class="label">P (ppm)</div><div class="value" id="p">–</div></div>
      <div class="card metric"><div class="label">K (ppm)</div><div class="value" id="k">–</div></div>
      <div class="card metric"><div class="label">MOI (%)</div><div class="value" id="moi">–</div></div>
      <div class="card metric"><div class="label">Battery (%)</div><div class="value" id="bat">–</div></div>
      <div class="card metric">
        <div class="label">Signal</div>
        <div class="value signal"><span id="rssi">–</span><small class="muted">/</small><span id="snr">–</span></div>
        <small class="muted" id="dev">–</small>
      </div>
    </div>

    <!-- Chart -->
    <div class="panel">
      <h3>Live Chart</h3>
      <canvas id="chart"></canvas>
    </div>

    <!-- Summary -->
    <div class="panel">
      <h3>Summary</h3>
      <div id="summaryGrid" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));"></div>
    </div>

    <!-- Table -->
    <div class="panel">
      <h3>Recent uplinks</h3>
      <div style="overflow:auto; max-height:380px;">
        <table>
          <thead>
            <tr>
              <th style="min-width:150px;">Time</th>
              <th>Device</th>
              <th>EC</th><th>pH</th><th>N</th><th>P</th><th>K</th><th>MOI</th><th>BAT</th>
              <th>RSSI</th><th>SNR</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Floating Theme Toggle (bottom-right) ===== -->
  <div class="theme-fab">
    <button id="themeToggle" class="fab-btn ripple-surface" type="button" aria-label="สลับธีม" title="สลับธีม (Light/Dark)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <!-- Sun/Moon hybrid icon; we rotate/fade parts in JS -->
        <g id="sun" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="4"></circle>
          <path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.5-1.5M20.5 20.5L19 19M5 19l-1.5 1.5M20.5 3.5L19 5"></path>
        </g>
        <g id="moon" fill="currentColor" opacity="0">
          <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79Z"></path>
        </g>
      </svg>
      <span class="label" id="themeLabel">Dark</span>
    </button>
  </div>

<script>
/* ================== CONFIG ================== */
/** 1) วางค่า SHEET_ID ของคุณ (ดูจาก URL ของ Google Sheet) */
const SHEET_ID   = '1iSRn3PrGgr0F7T-c-mKnEa-nmRU0PH626D3hLe7V7Jw';
/** 2) ชื่อชีท/แท็บ (เช่น 'data') */
const SHEET_NAME = 'data';
/** mapping ของคอลัมน์: A..L
 *  A=ts  B=deviceId  C=devEui  D=EC  E=pH  F=N  G=P  H=K  I=MOI  J=rssi  K=snr  L=BAT
 */
const COLS = { ts:0, device:1, devEui:2, ec:3, ph:4, n:5, p:6, k:7, moi:8, rssi:9, snr:10, bat:11 };

/* ============ helpers ============ */
function gvizURL(limit=100){
  const query = `select A,B,C,D,E,F,G,H,I,J,K,L order by A desc limit ${limit}`;
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json&tq=${encodeURIComponent(query)}`;
}
function parseGviz(text){
  const start = text.indexOf('(')+1;
  const end   = text.lastIndexOf(')');
  const json  = JSON.parse(text.slice(start, end));
  const rows  = (json.table.rows || []).map(r => (r.c.map(cell => cell ? cell.v : null)));
  return { rows };
}
function parseDateToken(v){
  if (typeof v === 'string' && v.startsWith('Date(')){
    const m = /Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/.exec(v);
    if (m){ const [_,y,mo,d,h,mi,s] = m.map(Number); return new Date(y, mo, d, h, mi, s); }
  }
  if (v instanceof Date) return v;
  return v ? new Date(v) : null;
}
function fmtTime(d){ return d ? dayjs(d).format('YYYY-MM-DD HH:mm:ss') : '–'; }
function toNum(v){ const n=Number(v); return Number.isFinite(n) ? n : null; }
function uniq(arr){ return [...new Set(arr)]; }

/* ============ state ============ */
let CHART;
let cache = [];
let timer;

/* ============ DOM refs ============ */
const ddDevice   = document.getElementById('deviceFilter');
const ddPoints   = document.getElementById('pointFilter');
const ddRefresh  = document.getElementById('refreshFilter');
const startDateFilter = document.getElementById('startDateFilter');
const endDateFilter = document.getElementById('endDateFilter');
const elUpdated  = document.getElementById('updated');
const elEC = document.getElementById('ec'); const elPH = document.getElementById('ph');
const elN  = document.getElementById('n'); const elP  = document.getElementById('p'); const elK  = document.getElementById('k');
const elMOI = document.getElementById('moi'); const elBAT = document.getElementById('bat');
const elRSSI = document.getElementById('rssi'); const elSNR  = document.getElementById('snr'); const elDev  = document.getElementById('dev');
const summaryGrid = document.getElementById('summaryGrid');
const tbody  = document.getElementById('tableBody');

/* ===== Theme helpers ===== */
function currentTheme(){ return document.documentElement.getAttribute('data-theme') || 'dark'; }
function setTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('smfarm-theme', theme);
  // Update toggle visuals
  const label = document.getElementById('themeLabel');
  const sun = document.querySelector('#sun'); const moon = document.querySelector('#moon');
  if (label){ label.textContent = theme === 'dark' ? 'Dark' : 'Light'; }
  if (sun && moon){
    if (theme === 'dark'){ sun.style.opacity = '0'; moon.style.opacity = '1'; }
    else { sun.style.opacity = '1'; moon.style.opacity = '0'; }
  }
  // Update chart UI colors
  applyChartTheme(theme);
}
function applyChartTheme(theme){
  if (!CHART) return;
  const legendColor = theme === 'dark' ? '#dfeaff' : '#334155';
  const tickColor   = theme === 'dark' ? '#bcd1ff' : '#47607b';
  const gridColor   = theme === 'dark' ? '#ffffff14' : '#00000014';
  CHART.options.plugins.legend.labels.color = legendColor;
  CHART.options.scales.x.ticks.color = tickColor;
  CHART.options.scales.y.ticks.color = tickColor;
  CHART.options.scales.x.grid.color  = gridColor;
  CHART.options.scales.y.grid.color  = gridColor;
  CHART.update('none');
}

/* ============ main fetch ============ */
async function fetchSheet(limit){
  const res  = await fetch(gvizURL(limit), {cache:'no-store'});
  const text = await res.text();
  const { rows } = parseGviz(text);

  cache = rows.map(r => ({
    ts:  parseDateToken(r[COLS.ts]),
    device: r[COLS.device] ?? '',
    devEui: r[COLS.devEui] ?? '',
    ec:  toNum(r[COLS.ec]),
    ph:  toNum(r[COLS.ph]),
    n:   toNum(r[COLS.n]),
    p:   toNum(r[COLS.p]),
    k:   toNum(r[COLS.k]),
    rssi:toNum(r[COLS.rssi]),
    snr: toNum(r[COLS.snr]),
    moi: toNum(r[COLS.moi]),
    bat: toNum(r[COLS.bat]),
  }));

  elUpdated.textContent = 'updated: ' + (cache[0] ? fmtTime(cache[0].ts) : '-');

  // build device filter
  const devices = uniq(cache.map(d => d.device).filter(Boolean));
  const cur = ddDevice.value;
  ddDevice.innerHTML = `<option value="">ทั้งหมด (${devices.length})</option>` +
    devices.map(x => `<option ${x===cur?'selected':''} value="${x}">${x}</option>`).join('');
}

function filterRows(){
  const device = ddDevice.value;
  const startDate = startDateFilter.value;
  const endDate = endDateFilter.value;

  let filtered = cache.slice();
  if (device) filtered = filtered.filter(r => r.device === device);

  if (startDate || endDate){
    filtered = filtered.filter(r => {
      if (!r.ts) return false;
      const rowDate = dayjs(r.ts).format('YYYY-MM-DD');
      if (startDate && rowDate < startDate) return false;
      if (endDate && rowDate > endDate) return false;
      return true;
    });
  }
  return filtered;
}

function updateKPIs(latest){
  const NIL='–';
  if (!latest){
    elEC.textContent = elPH.textContent = elN.textContent = elP.textContent = elK.textContent = elMOI.textContent = elBAT.textContent = NIL;
    elRSSI.textContent = elSNR.textContent = elDev.textContent = NIL;
    return;
  }
  elEC.textContent = latest.ec ?? NIL; elPH.textContent = latest.ph ?? NIL;
  elN.textContent  = latest.n  ?? NIL; elP.textContent  = latest.p  ?? NIL; elK.textContent  = latest.k  ?? NIL;
  elMOI.textContent = latest.moi ?? NIL; elBAT.textContent = latest.bat ?? NIL;
  elRSSI.textContent = (latest.rssi ?? NIL); elSNR.textContent = (latest.snr ?? NIL);
  elDev.textContent  = latest.device && latest.devEui ? `${latest.device} · ${latest.devEui}` : (latest.device || latest.devEui || NIL);
}

function updateSummary(rows) {
  const metrics = ['ec', 'ph', 'n', 'p', 'k', 'moi', 'bat'];
  summaryGrid.innerHTML = '';
  if (rows.length === 0) {
    summaryGrid.innerHTML = '<div class="muted">No data in selected range.</div>';
    return;
  }
  metrics.forEach(metric => {
    const values = rows.map(r => r[metric]).filter(v => v !== null && !isNaN(v));
    if (!values.length) return;
    const sum = values.reduce((a, b) => a + b, 0);
    const avg = sum / values.length;
    const min = Math.min(...values);
    const max = Math.max(...values);
    summaryGrid.insertAdjacentHTML('beforeend', `
      <div class="card metric" style="padding:12px;">
        <div class="label" style="text-transform: uppercase;">${metric}</div>
        <div style="font-size:14px; margin-top:4px;">Avg: <strong>${avg.toFixed(2)}</strong></div>
        <div style="font-size:12px;" class="muted">Min: ${min.toFixed(2)}</div>
        <div style="font-size:12px;" class="muted">Max: ${max.toFixed(2)}</div>
      </div>
    `);
  });
}

function updateTable(rows){
  tbody.innerHTML = rows.slice(0, 50).map(r => `
    <tr>
      <td>${fmtTime(r.ts)}</td>
      <td>${r.device || ''}</td>
      <td>${r.ec ?? ''}</td>
      <td>${r.ph ?? ''}</td>
      <td>${r.n ?? ''}</td>
      <td>${r.p ?? ''}</td>
      <td>${r.k ?? ''}</td>
      <td>${r.moi ?? ''}</td>
      <td>${r.bat ?? ''}</td>
      <td>${r.rssi ?? ''}</td>
      <td>${r.snr ?? ''}</td>
    </tr>`).join('');
}

function makeChart(ctx){
  return new Chart(ctx, {
    type:'line',
    data:{
      labels: [],
      datasets:[
        {label:'EC',  borderColor:'#60a5fa', backgroundColor:'transparent', data: [], tension:.25},
        {label:'pH',  borderColor:'#f472b6', backgroundColor:'transparent', data: [], tension:.25},
        {label:'N',   borderColor:'#f59e0b', backgroundColor:'transparent', data: [], tension:.25},
        {label:'P',   borderColor:'#fde047', backgroundColor:'transparent', data: [], tension:.25},
        {label:'K',   borderColor:'#34d399', backgroundColor:'transparent', data: [], tension:.25},
        {label:'MOI', borderColor:'#a78bfa', backgroundColor:'transparent', data: [], tension:.25},
        {label:'BAT', borderColor:'#22d3ee', backgroundColor:'transparent', data: [], tension:.25},
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'nearest', intersect:false },
      plugins:{ legend:{ labels:{ color:'#dfeaff' } } },
      scales:{
        x:{ ticks:{ color:'#bcd1ff' }, grid:{ color:'#ffffff14' } },
        y:{ ticks:{ color:'#bcd1ff' }, grid:{ color:'#ffffff14' } }
      }
    }
  });
}

function updateChart(rows){
  const labels = rows.map(r => dayjs(r.ts).format('HH:mm:ss')).reverse();
  const ec = rows.map(r => r.ec).reverse();
  const ph = rows.map(r => r.ph).reverse();
  const n  = rows.map(r => r.n).reverse();
  const p  = rows.map(r => r.p).reverse();
  const k  = rows.map(r => r.k).reverse();
  const moi = rows.map(r => r.moi).reverse();
  const bat = rows.map(r => r.bat).reverse();

  CHART.data.labels = labels;
  CHART.data.datasets[0].data = ec;
  CHART.data.datasets[1].data = ph;
  CHART.data.datasets[2].data = n;
  CHART.data.datasets[3].data = p;
  CHART.data.datasets[4].data = k;
  CHART.data.datasets[5].data = moi;
  CHART.data.datasets[6].data = bat;
  CHART.update('none');
}

/* ===== CSV Export ===== */
function exportCSV(){
  const rows = filterRows();
  const header = ['Time','Device','EC','pH','N','P','K','MOI','BAT','RSSI','SNR'];
  const lines = [header.join(',')].concat(rows.map(r => [
    fmtTime(r.ts), r.device || '', r.ec ?? '', r.ph ?? '', r.n ?? '', r.p ?? '', r.k ?? '', r.moi ?? '', r.bat ?? '', r.rssi ?? '', r.snr ?? ''
  ].map(v => {
    const s = (v ?? '').toString();
    return s.includes(',') ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const dev = ddDevice.value || 'all';
  const start = startDateFilter.value || 'start';
  const end = endDateFilter.value || 'end';
  a.download = `smfarm-${dev}-${start}_to_${end}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function setDateRange(days) {
  const today = dayjs().format('YYYY-MM-DD');
  let start = today;
  if (days > 0) start = dayjs().subtract(days - 1, 'day').format('YYYY-MM-DD');
  startDateFilter.value = start;
  endDateFilter.value = today;
  const changeEvent = new Event('change');
  startDateFilter.dispatchEvent(changeEvent);
  endDateFilter.dispatchEvent(changeEvent);
}

function exportCSVRange(startISO, endISO){
  const device = ddDevice.value;
  let rows = cache.slice();
  if (device) rows = rows.filter(r => r.device === device);

  const start = startISO ? dayjs(startISO) : null;
  const end   = endISO ? dayjs(endISO)   : null;
  if (start || end){
    rows = rows.filter(r => {
      if (!r.ts) return false;
      const t = dayjs(r.ts);
      if (start && t.isBefore(start)) return false;
      if (end && t.isAfter(end)) return false;
      return true;
    });
  }

  const header = ['Time','Device','EC','pH','N','P','K','MOI','BAT','RSSI','SNR'];
  const lines = [header.join(',')].concat(rows.map(r => [
    fmtTime(r.ts), r.device || '', r.ec ?? '', r.ph ?? '', r.n ?? '', r.p ?? '', r.k ?? '', r.moi ?? '', r.bat ?? '', r.rssi ?? '', r.snr ?? ''
  ].map(v => {
    const s = (v ?? '').toString();
    return s.includes(',') ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const dev = ddDevice.value || 'all';
  const sn = startISO ? dayjs(startISO).format('YYYY-MM-DD_HH-mm') : (startDateFilter.value || 'start');
  const en = endISO ? dayjs(endISO).format('YYYY-MM-DD_HH-mm') : (endDateFilter.value || 'end');
  a.download = `smfarm-${dev}-${sn}_to_${en}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

async function refresh(){
  const limit = Number(ddPoints.value || 100);
  await fetchSheet(limit);
  const rows = filterRows();
  const latest = rows[0];

  updateKPIs(latest);
  updateChart(rows);
  updateTable(rows);
  updateSummary(rows);
}

function startAuto(){
  if (timer) clearInterval(timer);
  const sec = Number(ddRefresh.value || 30);
  timer = setInterval(refresh, sec*1000);
}

/* ========= boot ========= */
window.addEventListener('DOMContentLoaded', async () => {
  // Theme toggle init (sync label/icon with current theme)
  setTheme(currentTheme());

  // Chart
  CHART = makeChart(document.getElementById('chart').getContext('2d'));
  applyChartTheme(currentTheme());

  // Date validation
  function validateDates() {
    const startDate = startDateFilter.value;
    const endDate = endDateFilter.value;
    if (startDate && endDate && startDate > endDate) endDateFilter.value = startDate;
  }
  function updateDateConstraints() {
    const startDate = startDateFilter.value;
    if (startDate) endDateFilter.setAttribute('min', startDate);
    else endDateFilter.removeAttribute('min');
  }

  // Export modal refs
  const exportModal = document.getElementById('exportModal');
  const exportStart = document.getElementById('exportStart');
  const exportEnd = document.getElementById('exportEnd');
  const exportCancel = document.getElementById('exportCancel');
  const exportConfirm = document.getElementById('exportConfirm');

  function openExport(){
    const now = dayjs();
    exportEnd.value = now.format('YYYY-MM-DDTHH:mm');
    const startHint = startDateFilter.value ? dayjs(startDateFilter.value).startOf('day') : now.subtract(7, 'day').startOf('day');
    exportStart.value = startHint.format('YYYY-MM-DDTHH:mm');
    exportModal.style.display = 'flex';
  }
  function closeExport(){ exportModal.style.display = 'none'; }

  document.getElementById('exportCsvBtn').addEventListener('click', openExport);
  exportCancel.addEventListener('click', closeExport);
  exportModal.addEventListener('click', (e) => { if (e.target === exportModal) closeExport(); });
  exportConfirm.addEventListener('click', () => {
    const s = exportStart.value, e = exportEnd.value;
    if (!s || !e){ alert('กรุณาเลือกช่วงวันและเวลาให้ครบ'); return; }
    if (s > e){ alert('วันที่สิ้นสุดต้องไม่ก่อนวันที่เริ่มต้น'); return; }
    closeExport(); exportCSVRange(s, e);
  });

  // Quick ranges
  document.getElementById('rangeToday').addEventListener('click', () => setDateRange(1));
  document.getElementById('range7').addEventListener('click', () => setDateRange(7));
  document.getElementById('range30').addEventListener('click', () => setDateRange(30));
  const rangeButtons = [ 'rangeToday','range7','range30' ].map(id=>document.getElementById(id));
  function setActiveRange(btn){
    rangeButtons.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    if (btn){ btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
  }
  rangeButtons.forEach(b => {
    b.addEventListener('click', (e)=> setActiveRange(e.currentTarget));
    b.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); b.click(); } });
  });

  // Filters
  ddDevice.addEventListener('change', () => { const rows=filterRows(); updateKPIs(rows[0]); updateChart(rows); updateTable(rows); updateSummary(rows); });
  startDateFilter.addEventListener('change', () => { updateDateConstraints(); validateDates(); const rows=filterRows(); updateKPIs(rows[0]); updateChart(rows); updateTable(rows); updateSummary(rows); });
  endDateFilter.addEventListener('change', () => { validateDates(); const rows=filterRows(); updateKPIs(rows[0]); updateChart(rows); updateTable(rows); updateSummary(rows); });
  ddPoints.addEventListener('change', refresh);
  ddRefresh.addEventListener('change', startAuto);

  // Ripple effect bind
  function addRipple(el){
    el.addEventListener('pointerdown', (e)=>{
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      const rect = el.getBoundingClientRect();
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      const size = Math.max(rect.width, rect.height);
      ripple.style.width = ripple.style.height = size + 'px';
      const x = e.clientX - rect.left - size/2;
      const y = e.clientY - rect.top - size/2;
      ripple.style.left = x + 'px'; ripple.style.top = y + 'px';
      el.appendChild(ripple);
      ripple.addEventListener('animationend', ()=> ripple.remove());
    });
  }
  document.querySelectorAll('.ripple-surface').forEach(addRipple);

  // Theme toggle button
  const themeBtn = document.getElementById('themeToggle');
  themeBtn.addEventListener('click', () => {
    const next = currentTheme() === 'dark' ? 'light' : 'dark';
    setTheme(next);
  });
  themeBtn.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); themeBtn.click(); } });

  // Safety hint if SHEET_ID is not set
  if (SHEET_ID === 'YOUR_SHEET_ID_HERE'){
    alert('กรุณาใส่ SHEET_ID ของคุณในไฟล์ก่อนใช้งาน');
  }

  await refresh();
  startAuto();
});
</script>
</body>
</html>
